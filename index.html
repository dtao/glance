<!DOCTYPE html>
<html>

<head>
  <title>CoderGlance</title>
  <script type="text/javascript" src="jquery.js"></script>
  <script type="text/javascript" src="d3.js"></script>
  <script type="text/javascript" src="d3-cloud.js"></script>

  <style type="text/css">
    #cloud {
      width: 960px;
      margin: auto;
    }
  </style>
</head>

<body>
  <form action="http://api.stackexchange.com/2.1/users/{id}/tags" method="GET">
    <input type="hidden" name="site" value="stackoverflow" />
    <input type="hidden" name="pagesize" value="100" />
    <input type="hidden" name="order" value="desc" />
    <input type="hidden" name="sort" value="popular" />

    <label for="stackoverflow-id">StackOverflow ID:</label>
    <input type="text" name="stackoverflow-id" />
    <input type="submit" />
  </form>

  <div id="cloud"></div>
</body>

<script type="text/javascript">
  var fill = d3.scale.category20b();

  var w = 960,
      h = 600,
      fontSize = d3.scale.log().range([16, 96]);

  var layout = d3.layout.cloud()
      .font("Impact")
      .spiral("archimedean")
      .timeInterval(10)
      .size([w, h])
      .fontSize(function(d) { return fontSize(+d.count); })
      .text(function(d) { return d.name; })
      .on("end", draw);

  var svg = d3.select("#cloud")
      .append("svg")
      .attr("width", w)
      .attr("height", h);

  var background = svg.append("g"),
      cloud = svg.append("g").attr("transform", "translate(" + [w >> 1, h >> 1] + ")");

  function draw(words, bounds) {
    var scale = bounds ? Math.min(
        w / Math.abs(bounds[1].x - w / 2),
        w / Math.abs(bounds[0].x - w / 2),
        h / Math.abs(bounds[1].y - h / 2),
        h / Math.abs(bounds[0].y - h / 2)) / 2 : 1;
    var text = cloud.selectAll("text")
        .data(words, function(d) {
          return d.text.toLowerCase();
        });
    text.transition()
        .duration(1000)
        .attr("transform", function(d) { return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")"; })
        .style("font-size", function(d) { return d.size + "px"; });
    text.enter().append("text")
        .attr("text-anchor", "middle")
        .attr("transform", function(d) { return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")"; })
        .style("font-size", function(d) { return d.size + "px"; })
        .style("opacity", 1e-6)
      .transition()
        .duration(1000)
        .style("opacity", 1);
    text.style("font-family", function(d) { return d.font; })
        .style("fill", function(d) { return fill(d.text.toLowerCase()); })
        .text(function(d) { return d.text; });
    var exitGroup = background.append("g")
        .attr("transform", cloud.attr("transform"));
    var exitGroupNode = exitGroup.node();
    text.exit().each(function() {
      exitGroupNode.appendChild(this);
    });
    exitGroup.transition()
        .duration(1000)
        .style("opacity", 1e-6)
        .remove();
    cloud.transition()
        .delay(1000)
        .duration(750)
        .attr("transform", "translate(" + [w >> 1, h >> 1] + ")scale(" + scale + ")");
  }

  function drawTags(tags) {
    layout.stop().words(tags, Math.min(tags.length, 100)).start();
  }

  var $body  = $("body"),
      $form  = $("form");

  $form.submit(function(e) {
    var userId = $("input[name='stackoverflow-id']", $form).val();

    e.preventDefault();

    var request = $.ajax({
      url: $form.attr("action").replace(/\{id\}/, userId),
      type: $form.attr("method"),
      dataType: "json",
      data: $form.serializeArray()
    });

    request.done(function(result) {
      drawTags(result.items);
    });

    request.fail(function() {
      alert(":(");
    });

    return false;
  });
</script>

</html>
